FROM docker.io/library/debian:bookworm

ARG DEBIAN_FRONTEND=noninteractive
ENV LANG=C.UTF-8

# basic deps
RUN \
    apt update -y && \
    apt install -y \
        bubblewrap \
        btrfs-progs \
        dosfstools \
        e2fsprogs \
        fdisk \
        podman \
        skopeo \
        systemd \
        systemd-timesyncd \
        systemd-boot* \
        kmod \
        locales \
        sudo \
        bash \
        bash-completion \
        util-linux \
        htop \
        e2fsprogs \
        parted \
        dbus \
        udev \
        network-manager \
        polkitd \
        net-tools \
        resolvconf \
        xfsprogs && \
    apt clean -y

# enable what is needed for systemd to work properly in the container
RUN \
    stat /sbin/init && \
    systemctl enable systemd-timesyncd

# copy the kernel
COPY modules /usr/lib/modules

# set the root passwordless
RUN echo "root ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# install the bootc and stuff
ENV CARGO_HOME=/tmp/rust
ENV RUSTUP_HOME=/tmp/rust

RUN \
    --mount=type=tmpfs,dst=/tmp \
    --mount=type=tmpfs,dst=/root \
    --mount=type=tmpfs,dst=/boot \
    apt update -y && \
    apt install -y \
        git \
        curl \
        make \
        build-essential \
        go-md2man \
        libzstd-dev \
        pkgconf \
        dracut \
        libostree-dev \
        ostree && \
    # install rust
    curl \
        --proto '=https' \
        --tlsv1.2 \
        -sSf "https://sh.rustup.rs" | sh -s -- --profile minimal -y && \
    # stub bootupctl: compile a tiny static binary that exits 0
    # so bootc's supports_bootupd() check passes and install doesn't
    # touch bootloader, at PhobOS level we use u-boot
    mkdir -p /usr/lib/bootupd/updates && \
    printf 'int main(void){return 0;}\n' > /tmp/bootupctl.c && \
    gcc -static -Os -s /tmp/bootupctl.c -o /usr/bin/bootupctl && \
    rm -f /tmp/bootupctl.c && \
    # build and install bootc
    git clone "https://github.com/gaiaBuildSystem/bootc.git" /tmp/bootc && \
    sh -c ". ${RUSTUP_HOME}/env ; make -C /tmp/bootc bin install-all" && \
    # cleanup
    apt purge -y \
        git \
        curl \
        make \
        build-essential \
        go-md2man \
        libzstd-dev \
        pkgconf \
        libostree-dev && \
    apt autoremove -y && \
    apt clean -y

# Necessary for general behavior expected by image-based systems
RUN \
    sed -i 's|^HOME=.*|HOME=/var/home|' "/etc/default/useradd" && \
    rm -rf /boot /home /root /usr/local /srv /var && \
    mkdir -p /sysroot /boot /usr/lib/ostree /var && \
    ln -s sysroot/ostree /ostree && \
    ln -s var/roothome /root && \
    ln -s var/srv /srv && \
    ln -s var/opt /opt && \
    ln -s var/mnt /mnt && \
    ln -s var/home /home && \
    echo "$(for dir in opt home srv mnt usrlocal ; do echo "d /var/$dir 0755 root root -" ; done)" | tee -a "/usr/lib/tmpfiles.d/bootc-base-dirs.conf" && \
    printf "d /var/roothome 0700 root root -\nd /run/media 0755 root root -" | tee -a "/usr/lib/tmpfiles.d/bootc-base-dirs.conf" && \
    printf '[sysroot]\nreadonly = true\n' | tee "/usr/lib/ostree/prepare-root.conf"

# this is bootc reccomendation
# to label the image as a bootable container
LABEL containers.bootc=1

# lint the image
RUN bootc container lint
